---
title:  算法压测方案
date: 2018-03-31 11:16:26
tags:
- ab
categories:
- 技术
comments: true
---
## 前期了解

### 算法情况

- 相关算法是添加180秒缓存，因此使压测数据有实际意义需要两种方式去执行，一种是简单去掉算法的缓存，二是压测的请求参数都是唯一不重复值去请求
- 部分算法是涉及java调用

### 现有轮子是否满足需求

现有主流压测工具

- [jmeter](http://jmeter.apache.org/download_jmeter.cgi)

  1.支持http请求

  2.本身并不提供图形化的实时数据展示功能

  3.用户操作并不友好，配置相对复杂

- ab

  1.简单粗暴

  2.不支持动态参数请求

- LoadRunner

  老牌压测工具


#### 目标

压测工具需要提供以下功能：

- 简单易用的操作界面（接入压测的时间应该控制在1小时以内）
- 清晰的图表能反映压测应用的各项指标
- 支持HTTP压测需求

### 总结

**1.整体上说jmeter满足需求**

与目前想看，需求上还是满足当前需求的。

**2.实时数据展示**

JMeter本身并不提供图形化的实时数据展示功能，以往我们只能通过JMeter Log看到一些粗略的信息，并结合外部监控工具观察指标情况。可以通过JMeter的Backend Listener (JMeter 3.2+)，将测试结果实时发往InfluxDB，同时通过web_ui向InfluxDB轮询查询数据，得到实时曲线并展示给用户。

## 开始落地

### 制造真实请求数据

编写生产环境数据生产导出

###  监控线上情况

目前只能通过简单观察服务器资源情况以及报警状态判断稳定性

### 压测爬坡

数据量压测预设目标，不是一次达到，而有目的分开几个阶段，如每次增加100，每次持续5分钟等去慢慢爬坡压测。

### 到达第一个瓶颈的分析与优化

初步压测得到的瓶颈不是压测的终点，而只是开始，这时候需要结合分析：

- 1.算法服务能力达到瓶颈了，拖累QPS不上去 
- 2.网关本身能力达到瓶颈
- 3.中间件/数据库/Redis 能力达到瓶颈

针对第二三点出现问题核心是资源不够，添加服务器是相对比较快的速度去解决瓶颈办法；而针对出现的第一种情况，结合数据分析，如果是与预想相比实在低下，首先要做的检查业务逻辑，并切实拿出优化或者重构方案，不然还是需要添加服务器去支持。

## 未来展望

当前，这个方案做得还较粗糙，还存在一些问题：

- 1 压测只能在夜间做。 
- 2 链路规划复杂度太高。 
- 3 压测稳定性还不够高。 
- 4 瓶颈检测与流量干预是通过肉眼来观看监控来实现。

后续可以继续投入大精力去完善整个方案。希望可以做到，压测的方案可以变成： 

- 1 压测任何时候都可以进行。 
- 2 链路规划图形化，并与数据结合， 完成数据的准备工作。 
- 3 瓶颈检测与流量干预来保护系统，让业务系统不会被压崩溃。